<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulir Pengenalan Diri</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: '#0f172a',
            accent: '#22d3ee',
            danger: '#ef4444'
          }
        }
      }
    };
  </script>
  <style>
    input[type="radio"] + label {
      pointer-events: auto;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      text-align: center;
      border-radius: 9999px;
      border: 1px solid #ccc;
      background-color: #f3f4f6;
      font-weight: 600;
      transition: background-color 0.3s, color 0.3s;
    }

    input[type="radio"]:checked + label {
      background-color: #22d3ee;
      color: black;
      border-color: #22d3ee;
    }

    input[type="radio"] + label:hover {
      background-color: #22d3ee;
      color: black;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-pink-100 to-yellow-100 min-h-screen flex flex-col items-center justify-center px-4 relative">
  <div class="bg-white w-full max-w-3xl p-6 rounded-3xl shadow-xl space-y-6 mb-24">
    <h1 class="text-3xl font-bold text-center text-accent">FORMULIR DAN PENGENALAN DIRI</h1>
    <form id="user" class="space-y-4">
      <div><label class="block text-sm font-medium">Upload Foto</label><input type="file" name="foto" required class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" /></div>
      <div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="nama" required class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" /></div>
      <div><label class="block text-sm font-medium">Asal Sekolah/Kota</label><input type="text" name="asal" required class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" /></div>
      <div><label class="block text-sm font-medium">Nomor HP</label><input type="tel" name="hp" required class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" /></div>
      <div><label class="block text-sm font-medium">Email</label><input type="email" name="email" required class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" /></div>
      <div><label class="block text-sm font-medium">Usia</label><input type="number" name="usia" required class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" min="5" max="100" /></div>
      <div><label class="block text-sm font-medium">Cerita Singkat Mengenai Diri Anda</label><textarea name="cerita" rows="3" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" required></textarea></div>
      <div>
        <label class="block text-sm font-medium">Apa alasan kamu bergabung?</label>
        <select name="alasan" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" required>
          <option value="">Pilih salah satu</option>
          <option value="Eksplorasi Diri">Eksplorasi Diri</option>
          <option value="Bimbingan">Bimbingan</option>
          <option value="Tugas">Tugas</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium">Upload Surat Perjanjian (admin)</label>
        <input type="file" name="surat" class="w-full border border-gray-300 rounded px-3 py-2 bg-gray-50" />
      </div>

      <!-- Multi-step Pertanyaan -->
      <div id="multi-step-form" class="space-y-4"></div>

      <div id="form-navigation" class="flex justify-between mt-6">
        <button type="button" id="prevBtn" class="bg-gray-300 px-4 py-2 rounded hidden">Kembali</button>
        <button type="button" id="nextBtn" class="bg-accent px-4 py-2 rounded text-black">Lanjut</button>
      </div>

      <!-- Hasil -->
      <div id="result-container" class="hidden mt-6 p-4 bg-green-100 rounded-xl shadow-md">
        <h2 class="text-xl font-bold text-green-800 mb-2">üí° Hasil Interpretasi:</h2>
        <div id="resultTable" class="text-sm text-gray-800 space-y-3"></div>
      </div>
      <div class="mt-4 flex gap-4 flex-wrap">
        <button onclick="saveToFirestore()" type="button" class="bg-blue-600 text-white px-4 py-2 rounded">Simpan Hasil</button>
        <button onclick="exportPDF()" type="button" class="bg-green-600 text-white px-4 py-2 rounded">Unduh PDF</button>
        <button onclick="toIndex()" type="button" class="bg-gray-700 text-white px-4 py-2 rounded">Masuk Ke Beranda</button>
      </div>

      <button type="submit" class="w-full bg-accent text-black font-semibold py-3 rounded-lg hover:opacity-90 transition mt-4">Kirim Formulir</button>
    </form>
  </div>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBA_C0CVbAMipzGPE2wD9hY3-YoyNYPLMU",
    authDomain: "gps-tracker-4a27c.firebaseapp.com",
    projectId: "gps-tracker-4a27c",
    storageBucket: "gps-tracker-4a27c.appspot.com",
    messagingSenderId: "334120793213",
    appId: "1:334120793213:web:71b868b85bc6f01261ed14"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
    } else {
      window.location.href = "login.html";
    }
  });
</script>

<script>
const questions = [
  { text: "Saya mudah berkenalan dengan orang baru", part: 1 },
  { text: "Saya nyaman berbicara di depan banyak orang", part: 1 },
  { text: "Saya suka mengikuti kegiatan komunitas", part: 1 },
  { text: "Saya sering memulai percakapan", part: 1 },
  { text: "Saya merasa diterima di lingkungan sekitar", part: 1 },
  { text: "Saya sering membantu orang lain", part: 1 },
  { text: "Saya mampu bekerja sama dalam tim", part: 1 },
  { text: "Saya mudah memahami perasaan orang lain", part: 1 },
  { text: "Saya senang menjadi bagian dari kelompok", part: 1 },
  { text: "Saya memiliki banyak teman dekat", part: 1 },

  { text: "Saya cepat memahami pelajaran logika", part: 2 },
  { text: "Saya menyukai permainan strategi", part: 2 },
  { text: "Saya mampu mengambil keputusan berdasarkan data", part: 2 },
  { text: "Saya tertarik pada matematika atau sains", part: 2 },
  { text: "Saya suka mengamati pola kejadian", part: 2 },
  { text: "Saya menyukai tantangan yang memerlukan pemikiran", part: 2 },
  { text: "Saya mampu menganalisis masalah dari berbagai sudut", part: 2 },
  { text: "Saya sering diminta pendapat untuk menyelesaikan masalah", part: 2 },
  { text: "Saya percaya diri dalam membuat keputusan rasional", part: 2 },
  { text: "Saya terbiasa berpikir sebelum bertindak", part: 2 },

  { text: "Saya mudah menyadari suasana hati saya", part: 3 },
  { text: "Saya bisa menenangkan diri saat marah", part: 3 },
  { text: "Saya peduli pada orang lain", part: 3 },
  { text: "Saya bisa membayangkan perasaan orang lain", part: 3 },
  { text: "Saya tidak mudah tersinggung", part: 3 },
  { text: "Saya bisa mendengarkan orang lain dengan baik", part: 3 },
  { text: "Saya bisa mengendalikan rasa cemas", part: 3 },
  { text: "Saya terbuka terhadap kritik", part: 3 },
  { text: "Saya tidak segan meminta maaf", part: 3 },
  { text: "Saya mampu memaafkan kesalahan orang lain", part: 3 },

  { text: "Saya menyelesaikan tugas tepat waktu", part: 4 },
  { text: "Saya menjaga komitmen yang saya buat", part: 4 },
  { text: "Saya tidak mudah menyerah", part: 4 },
  { text: "Saya memiliki jadwal harian", part: 4 },
  { text: "Saya bisa fokus dalam waktu lama", part: 4 },
  { text: "Saya mengerjakan pekerjaan rumah tanpa disuruh", part: 4 },
  { text: "Saya memperhatikan detail dalam tugas", part: 4 },
  { text: "Saya bisa memimpin suatu kegiatan", part: 4 },
  { text: "Saya belajar dari kesalahan", part: 4 },
  { text: "Saya bertanggung jawab atas tindakan saya", part: 4 },

  { text: "Saya senang menggambar atau menciptakan karya seni", part: 5 },
  { text: "Saya memiliki ide-ide unik", part: 5 },
  { text: "Saya menyukai cerita atau dongeng", part: 5 },
  { text: "Saya sering memiliki solusi tidak biasa", part: 5 },
  { text: "Saya tertarik menciptakan sesuatu baru", part: 5 },
  { text: "Saya menulis cerita atau puisi", part: 5 },
  { text: "Saya suka bereksperimen", part: 5 },
  { text: "Saya menggunakan imajinasi saat bermain", part: 5 },
  { text: "Saya tertarik pada dunia seni", part: 5 },
  { text: "Saya bisa berpikir 'di luar kotak'", part: 5 },

  { text: "Saya memiliki cita-cita yang jelas", part: 6 },
  { text: "Saya tahu langkah yang harus saya ambil", part: 6 },
  { text: "Saya memiliki semangat belajar yang tinggi", part: 6 },
  { text: "Saya merasa yakin dengan masa depan saya", part: 6 },
  { text: "Saya punya target hidup jangka panjang", part: 6 },
  { text: "Saya mencari inspirasi dari tokoh sukses", part: 6 },
  { text: "Saya terus mencoba walau gagal", part: 6 },
  { text: "Saya termotivasi melihat kemajuan orang lain", part: 6 },
  { text: "Saya bekerja keras demi masa depan", part: 6 },
  { text: "Saya ingin membuat perubahan positif", part: 6 },

  { text: "Saya menjaga pola makan sehat", part: 7 },
  { text: "Saya berolahraga secara rutin", part: 7 },
  { text: "Saya cukup tidur setiap hari", part: 7 },
  { text: "Saya tahu cara mengelola stres", part: 7 },
  { text: "Saya menyadari pentingnya istirahat", part: 7 },
  { text: "Saya menjaga kebersihan tubuh", part: 7 },
  { text: "Saya memeriksakan kesehatan secara berkala", part: 7 },
  { text: "Saya menjaga waktu main dan belajar", part: 7 },
  { text: "Saya tidak sering begadang", part: 7 },
  { text: "Saya menyadari pentingnya kesehatan mental", part: 7 },

  { text: "Keluarga saya memiliki rumah sendiri", part: 8 },
  { text: "Saya bisa membeli barang tanpa harus menabung lama", part: 8 },
  { text: "Orang tua saya memiliki pekerjaan tetap", part: 8 },
  { text: "Saya memiliki akses internet di rumah", part: 8 },
  { text: "Saya memiliki kamar tidur sendiri", part: 8 },
  { text: "Keluarga saya memiliki kendaraan pribadi", part: 8 },
  { text: "Kami rutin berlibur bersama", part: 8 },
  { text: "Saya memiliki lebih dari satu pasang sepatu", part: 8 },
  { text: "Saya tidak pernah kesulitan makan", part: 8 },
  { text: "Saya punya tempat belajar sendiri di rumah", part: 8 },
  { text: "Keluarga saya mendukung pendidikan saya", part: 8 },
  { text: "Saya merasa aman dan nyaman di rumah", part: 8 },
  { text: "Saya sering diajak berdiskusi oleh orang tua", part: 8 },
  { text: "Kami punya tabungan keluarga", part: 8 },
  { text: "Kami bisa memenuhi kebutuhan dasar dengan baik", part: 8 },
];

const interpretations = {
  1: "Sosialisasi: Kamu mudah akrab dengan orang lain.",
  2: "Logika & Analisis: Kamu memiliki kemampuan berpikir logis yang kuat.",
  3: "Emosi & Empati: Kamu mampu mengelola dan memahami emosi.",
  4: "Kedisiplinan: Kamu bertanggung jawab dan disiplin.",
  5: "Kreativitas: Kamu memiliki imajinasi dan ide-ide unik.",
  6: "Motivasi: Kamu memiliki tujuan hidup dan semangat tinggi.",
  7: "Kesehatan: Kamu menjaga keseimbangan hidup dengan baik.",
  8: "Latar Belakang Ekonomi: Kamu berasal dari keluarga dengan kondisi relatif stabil."
};

let currentPart = 1;
const totalParts = 8;
let scores = {};
let answers = {};
const formContainer = document.getElementById("multi-step-form");
const nextBtn = document.getElementById("nextBtn");
const prevBtn = document.getElementById("prevBtn");
const resultContainer = document.getElementById("result-container");
const resultTable = document.getElementById("resultTable");

// Progress info
const progressInfo = document.createElement('div');
progressInfo.id = "progressInfo";
progressInfo.className = "text-center font-medium text-sm text-gray-600 mt-2";
document.getElementById("form-navigation").prepend(progressInfo);

function updateProgressInfo() {
  progressInfo.innerText = `Bagian ${currentPart} dari ${totalParts}`;
}

function renderQuestions() {
  formContainer.innerHTML = "";
  const partQuestions = questions
    .map((q, i) => ({ ...q, index: i }))
    .filter(q => q.part === currentPart);

  partQuestions.forEach(q => {
    const highlight = (q.index >= 55 && q.index <= 59) ? "bg-yellow-100 border-yellow-400" : "";
    const qDiv = document.createElement("div");
    qDiv.className = `mb-3 p-2 rounded border ${highlight}`;
    qDiv.innerHTML = `
      <p class="font-medium mb-2">${q.index + 1}. ${q.text}</p>
      <div class="flex gap-2 flex-wrap">
        ${[1, 2, 3, 4, 5].map(val => `
          <input type="radio" name="q${q.index}" id="q${q.index}_${val}" value="${val}" class="hidden" ${answers[q.index] == val ? "checked" : ""}>
          <label for="q${q.index}_${val}" class="cursor-pointer border px-4 py-2 rounded-full">${val}</label>
        `).join("")}
      </div>
    `;
    formContainer.appendChild(qDiv);
  });

  prevBtn.classList.toggle("hidden", currentPart === 1);
  nextBtn.textContent = currentPart === totalParts ? "Lihat Hasil" : "Lanjut";
  updateProgressInfo();
}

nextBtn.addEventListener("click", () => {
  const partQuestions = questions
    .map((q, i) => ({ ...q, index: i }))
    .filter(q => q.part === currentPart);

  let valid = true;

  partQuestions.forEach(q => {
    const selected = document.querySelector(`input[name="q${q.index}"]:checked`);
    if (!selected) {
      alert(`Silakan isi pertanyaan nomor ${q.index + 1}`);
      valid = false;
    } else {
      answers[q.index] = parseInt(selected.value);
    }
  });

  if (valid) {
    if (currentPart < totalParts) {
      currentPart++;
      renderQuestions();
    } else {
      calculateScores();
      showResults();
    }
  }
});

prevBtn.addEventListener("click", () => {
  if (currentPart > 1) {
    currentPart--;
    renderQuestions();
  }
});

function calculateScores() {
  scores = {};
  questions.forEach((q, i) => {
    const value = answers[i] || 0;
    if (!scores[q.part]) scores[q.part] = 0;
    scores[q.part] += value;
  });
}

function showResults() {
  resultContainer.classList.remove("hidden");
  resultTable.innerHTML = "";
  for (let part in scores) {
    const partScore = scores[part];
    const max = questions.filter(q => q.part == part).length * 5;
    const percent = Math.round((partScore / max) * 100);
    resultTable.innerHTML += `
      <div class="p-2 border rounded-md bg-white shadow-sm mb-3">
        <strong>Bagian ${part}</strong>: Skor ${partScore}/${max} (${percent}%)<br />
        <span class="text-gray-700">${interpretations[part]}</span>
      </div>
    `;
  }
  resultContainer.scrollIntoView({ behavior: "smooth" });
}
</script>
<!-- Submit ke Firestore -->
<script>
function interpretasiPerBagian(jawaban) {
  let skorPerBagian = {};
  let hasil = [];

  questions.forEach((q, i) => {
    const nilai = jawaban[i] || 0;
    if (!skorPerBagian[q.part]) skorPerBagian[q.part] = 0;
    skorPerBagian[q.part] += nilai;
  });

  for (let i = 1; i <= totalParts; i++) {
    const max = questions.filter(q => q.part === i).length * 5;
    const nilai = skorPerBagian[i] || 0;
    const persen = Math.round((nilai / max) * 100);
    hasil.push({
      bagian: `Bagian ${i}`,
      skor: `${nilai}/${max}`,
      persen,
      interpretasi: interpretations[i]
    });
  }

  return hasil;
}

async function saveToFirestore() {
  if (!currentUser) {
    alert("üîí Harus login terlebih dahulu.");
    return;
  }

  const formData = new FormData(document.getElementById("user"));
  const nama = formData.get("nama");
  const hp = formData.get("hp");
  const usia = formData.get("usia");
  const cerita = formData.get("cerita");
  const alasan = formData.get("alasan");
  const email = formData.get("email");

  if (!nama || !hp || !usia || !cerita || !alasan || !email) {
    alert("‚ö†Ô∏è Semua kolom wajib diisi.");
    return;
  }

  calculateScores(); // ‚Üê pastikan skor sudah dihitung
let hasilInterpretasi = [];

for (let part in scores) {
  const partScore = scores[part];
  const max = questions.filter(q => q.part == part).length * 5;
  const percent = Math.round((partScore / max) * 100);
  hasilInterpretasi.push({
    bagian: `Bagian ${part}`,
    interpretasi: interpretations[part],
    skor: `${partScore}/${max} (${percent}%)`
  });
}

// Ini hasil final yang akan dikirim ke Firestore
const interpretasi = hasilInterpretasi.map(b => `${b.bagian}: ${b.interpretasi} | Skor ${b.skor}`).join("\n");

  try {
  await db.collection("user").add({
    uid: currentUser.uid,
    email,
    nama,
    hp,
    usia,
    cerita,
    alasan,
    jawaban: answers,
    interpretasi,
    waktu: new Date().toISOString()
  });

  alert("‚úÖ Data berhasil dikirim!");

  // Tambahkan session login agar bisa akses index.html
  sessionStorage.setItem("fromLogin", "true");
  window.location.href = "index.html";

} catch (err) {
  console.error("Firestore error:", err);
  alert("‚ùå Gagal menyimpan: " + err.message);
}

}

// Tangkap submit formulir
document.getElementById("user").addEventListener("submit", function (e) {
  e.preventDefault();
  saveToFirestore();
});
</script>

<!-- Export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
function exportPDF() {
  const nama = document.querySelector('input[name="nama"]').value || "tanpa_nama";
  const element = document.getElementById("result-container");

  html2pdf()
    .set({
      margin: 0.5,
      filename: `Hasil_Pengenalan_${nama}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: "in", format: "a4", orientation: "portrait" }
    })
    .from(element)
    .save();
}
</script>

<!-- Trigger render pertanyaan saat page load -->
<script>
  document.addEventListener("DOMContentLoaded", () => {
    renderQuestions();
  });
</script>

<!-- ‚úÖ Tambahkan fungsi redirect ini di bawah -->
<script>
function toIndex() {
  sessionStorage.setItem("fromLogin", "true");
  window.location.href = "index.html";
}
</script>
